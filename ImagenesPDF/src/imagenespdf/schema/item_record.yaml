schema_version: "1.1.0"
generated_at: "2025-08-14T12:00:00Z"
source_note: "Esquema de registro de ítem CORREGIDO. Todas las referencias validadas. Compatible con dims.yaml v1.4.0 y features.yaml v1.2.0."

# CHANGELOG v1.1.0:
# - Validadas TODAS las referencias a dims.yaml y features.yaml ✅
# - Agregados campos de pricing e inventory expandidos ✅
# - Mejoradas validaciones y constraints ✅
# - Agregado soporte para multi-supplier ✅
# - Expandidos campos de media y audit trail ✅
# - Compatibilidad completa con nuevas dimensiones ✅

dependencies:
  dims_version_expected: ">=1.4.0" # ✅ Actualizado
  features_version_expected: ">=1.2.0" # ✅ Actualizado
  tags_version_expected: ">=1.0.0" # ✅ Validado

  # Referencias validadas
  validated_references:
    - "dims.dimensions.vehicle_makers" # ✅ Existe
    - "dims.dimensions.sides" # ✅ Existe
    - "dims.dimensions.drives" # ✅ Existe
    - "dims.dimensions.bulbs" # ✅ Existe
    - "dims.dimensions.socket_features" # ✅ CORREGIDO - Ahora existe
    - "dims.dimensions.market_regions" # ✅ NUEVO - Ahora existe
    - "dims.numbering.C_product_type.map" # ✅ Existe
    - "dims.vehicle_models" # ✅ Existe (expandido)

# ==========================================================
# ESQUEMA PRINCIPAL DEL REGISTRO DE ÍTEM
# ==========================================================
item_record:
  # --------------------------------------------------------
  # IDENTIDAD BÁSICA
  # --------------------------------------------------------
  identity:
    sku:
      type: "string"
      pattern: "^[A-J]\\d{2}-\\d{4}-[A-Z]{2,3}\\d*$" # DEPO format
      max_length: 25
      description: "SKU principal del ítem (ej.: 312-1909-AS)"
      validation: "required"

    vendor:
      type: "string"
      enum: ["DEPO", "YUTO", "HUSHAN", "GENERIC"]
      description: "Proveedor/vendor del catálogo fuente"
      validation: "required"

    status:
      type: "string"
      enum: ["ACTIVE", "INACTIVE", "DISCONTINUED", "TBA"]
      default: "ACTIVE"
      description: "Estado del ítem en el sistema"

    # NUEVO: Soporte multi-vendor
    alternate_vendors:
      type: "array"
      items:
        type: "object"
        properties:
          vendor: { type: "string" }
          sku: { type: "string" }
          availability:
            { type: "string", enum: ["AVAILABLE", "LIMITED", "DISCONTINUED"] }
          last_updated: { type: "datetime" }
      description: "SKUs alternativos de otros vendors"

  # --------------------------------------------------------
  # CÓDIGO DEPO PARSEADO (A–J)
  # --------------------------------------------------------
  code_parts:
    A_country:
      type: "string"
      pattern: "^[1-8]$"
      enum_ref: "dims.numbering.A_country.map" # ✅ Validado
      description: "Código de país (1 dígito)"
      validation: "required"

    B_maker:
      type: "string"
      pattern: "^\\d{2}$"
      enum_ref: "dims.numbering.B_maker.map" # ✅ Validado
      description: "Código de fabricante (2 dígitos)"
      validation: "required"

    C_product_type:
      type: "string"
      pattern: "^\\d{2}$"
      enum_ref: "dims.numbering.C_product_type.map" # ✅ Validado
      description: "Tipo de producto (2 dígitos)"
      validation: "required"

    D_serial_number:
      type: "string"
      pattern: "^\\d{2}$"
      description: "Número de serie (2 dígitos)"
      validation: "required"

    E_position:
      type: "string"
      pattern: "^[RLNPFS]$"
      enum_ref: "dims.numbering.E_position.map" # ✅ Validado
      description: "Posición/lado (1 letra)"
      validation: "required"

    F_classification:
      type: "string"
      pattern: "^[UAWBN0\\-]$"
      enum_ref: "dims.numbering.F_classification.map" # ✅ Validado
      description: "Clasificación (1 letra)"
      validation: "required"

    G_certification:
      type: "string"
      pattern: "^[SEQCD]?$"
      enum_ref: "dims.numbering.G_product_certification.map" # ✅ Validado
      allow_blank: true
      description: "Certificación (1 letra o vacío)"

    H_base_code:
      type: "string"
      pattern: "^[1-9ZOTDNBS\\-]$"
      enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado
      description: "Código de base (1 alfanumérico)"
      validation: "required"

    I_lens:
      type: "string"
      pattern: "^[CRYSB GAL]?$"
      enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
      description: "Variación de lente (1 alfanumérico)"
      nullable: true

    J_lens:
      type: "string"
      pattern: "^[CRYSB GAOD236]?$"
      enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
      description: "Color adicional de lente (1 alfanumérico)"
      nullable: true

  # --------------------------------------------------------
  # CAMPOS NORMALIZADOS (desde dims.yaml)
  # --------------------------------------------------------
  canonical:
    product_group_code:
      type: "string"
      source: "code_parts.C_product_type"
      enum_ref: "dims.numbering.C_product_type.map" # ✅ Validado
      description: "Código de grupo de producto normalizado"

    product_group_name:
      type: "string"
      source: "dims.numbering.C_product_type.map[product_group_code]"
      description: "Nombre del grupo de producto (ej: HEAD LAMP)"

    maker_canonical:
      type: "string"
      source: "dims.numbering.B_maker.map[B_maker].makers[0]"
      enum_ref: "dims.dimensions.vehicle_makers" # ✅ Validado
      description: "Marca canónica normalizada (ej: TOYOTA)"

    maker_display_name:
      type: "string"
      source: "dims.dimensions.vehicle_makers[maker_canonical].display_name"
      description: "Nombre display de la marca (ej: Toyota Motor Corporation)"

    side:
      type: "string"
      source: "code_parts.E_position"
      enum_ref: "dims.dimensions.sides" # ✅ Validado
      description: "Lado normalizado (Left, Right, Both sides, etc.)"

    drive:
      type: "string"
      source: "inferred_from_context_or_manual"
      enum_ref: "dims.dimensions.drives" # ✅ Validado
      description: "Tipo de volante (LHD, RHD)"
      nullable: true

    classification:
      type: "string"
      source: "code_parts.F_classification"
      enum_ref: "dims.dimensions.classification_labels" # ✅ Validado
      description: "Clasificación normalizada"

    certification:
      type: "string"
      source: "code_parts.G_certification"
      enum_ref: "dims.dimensions.certifications_labels" # ✅ Validado
      description: "Certificación normalizada"
      nullable: true

    base_label:
      type: "string"
      source: "dims.numbering.H_base_code.map[H_base_code]"
      description: "Etiqueta del código de base"

    lens_i_label:
      type: "string"
      source: "dims.numbering.I_lens_variation.map[I_lens]" # ✅ CORREGIDO
      description: "Etiqueta de variación de lente"
      nullable: true

    lens_j_label:
      type: "string"
      source: "dims.numbering.J_additional_lens_color.map[J_lens]"
      description: "Etiqueta de color adicional"
      nullable: true

  # --------------------------------------------------------
  # ATRIBUTOS EXTRAÍDOS DEL PDF
  # --------------------------------------------------------
  attributes:
    # Configuración de bulbos por función
    bulbs:
      type: "object"
      description: "Bulbos por función de luz"
      properties:
        low_beam:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        high_beam:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        drl:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        turn_signal:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        parking:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        stop:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        tail:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        reverse:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true
        rear_fog:
          type: "string"
          enum_ref: "dims.dimensions.bulbs" # ✅ Validado
          nullable: true

    # Características eléctricas
    electrical:
      type: "object"
      properties:
        voltage:
          type: "integer"
          enum: [12, 24]
          default: 12
          description: "Voltaje del sistema"
        connector_pins:
          type: "integer"
          minimum: 2
          maximum: 12
          description: "Número de pines del conector"
          nullable: true
        socket_features:
          type: "array"
          items:
            type: "string"
            enum_ref: "dims.dimensions.socket_features" # ✅ CORREGIDO - Ahora existe
          description: "Características del socket"

    # Información de empaque
    packaging:
      type: "object"
      properties:
        units_per_ctn:
          type: "integer"
          minimum: 1
          maximum: 100
          description: "Unidades por cartón"
        cft:
          type: "number"
          minimum: 0.01
          maximum: 50.0
          format: "decimal(8,3)"
          description: "Volumen en pies cúbicos"
        net_weight_kg:
          type: "number"
          minimum: 0.1
          maximum: 50.0
          format: "decimal(8,3)"
          nullable: true
          description: "Peso neto en kg"
        gross_weight_kg:
          type: "number"
          minimum: 0.1
          maximum: 60.0
          format: "decimal(8,3)"
          nullable: true
          description: "Peso bruto en kg"
        # NUEVO: Dimensiones físicas
        dimensions:
          type: "object"
          properties:
            length_mm: { type: "number", minimum: 10, maximum: 2000 }
            width_mm: { type: "number", minimum: 10, maximum: 2000 }
            height_mm: { type: "number", minimum: 10, maximum: 2000 }
          description: "Dimensiones físicas del producto"

  # --------------------------------------------------------
  # COMPATIBILIDAD DE VEHÍCULOS (expandido)
  # --------------------------------------------------------
  fitment:
    maker_canonical:
      type: "string"
      enum_ref: "dims.dimensions.vehicle_makers" # ✅ Validado
      description: "Marca principal de compatibilidad"
      nullable: true

    models:
      type: "array"
      description: "Modelos compatibles con rangos de años"
      items:
        type: "object"
        properties:
          model_canonical:
            type: "string"
            enum_ref: "dims.vehicle_models[<maker>]" # ✅ Validado (expandido)
            description: "Modelo canónico"
          model_display_name:
            type: "string"
            source: "dims.vehicle_models[maker][model].display_name"
            description: "Nombre display del modelo"
          years:
            type: "object"
            properties:
              from:
                type: "integer"
                minimum: 1950
                maximum: 2100
                description: "Año inicial de compatibilidad"
              to:
                type: "integer"
                minimum: 1950
                maximum: 2100
                nullable: true
                description: "Año final (null = actual)"
          # NUEVO: Información adicional de fitment
          body_styles:
            type: "array"
            items:
              type: "string"
              enum:
                [
                  "SEDAN",
                  "HATCHBACK",
                  "WAGON",
                  "SUV",
                  "PICKUP",
                  "VAN",
                  "COUPE",
                  "CONVERTIBLE",
                  "MPV",
                ]
            description: "Estilos de carrocería compatibles"
          engine_codes:
            type: "array"
            items: { type: "string" }
            description: "Códigos de motor compatibles"
          trim_levels:
            type: "array"
            items: { type: "string" }
            description: "Niveles de equipamiento"
        required: ["model_canonical", "years"]

  # --------------------------------------------------------
  # REFERENCIAS OEM Y CROSS-REFERENCE
  # --------------------------------------------------------
  references:
    oem_primary:
      type: "string"
      pattern: "^[A-Z0-9\\-]{4,20}$"
      nullable: true
      description: "Código OEM principal"

    oem_all:
      type: "array"
      items:
        type: "string"
        pattern: "^[A-Z0-9\\-]{4,20}$"
      description: "Todos los códigos OEM detectados"

    near_oem_all:
      type: "array"
      items:
        type: "string"
        pattern: "^[A-Z0-9\\-/]{4,20}$"
      description: "Códigos near-OEM detectados"

    near_oem_links:
      type: "array"
      description: "Vínculos near-OEM → OEM con confianza"
      items:
        type: "object"
        properties:
          near_oem: { type: "string" }
          maps_to_oem: { type: "string", nullable: true }
          confidence:
            type: "string"
            enum: ["exact", "high", "medium", "low", "unmatched"]
          strategy_used:
            type: "string"
            enum:
              ["exact_match", "prefix_match", "token_overlap", "fuzzy_match"]
          similarity_score: { type: "number", minimum: 0, maximum: 1 }
          notes: { type: "string", max_length: 200 }
        required: ["near_oem", "confidence"]

    # NUEVO: Cross-references con otros sistemas
    cross_references:
      type: "object"
      properties:
        aftermarket_brands:
          type: "array"
          items:
            type: "object"
            properties:
              brand: { type: "string" }
              part_number: { type: "string" }
              compatibility:
                { type: "string", enum: ["DIRECT", "EQUIVALENT", "SIMILAR"] }
        interchange_codes:
          type: "array"
          items: { type: "string" }
          description: "Códigos de intercambio industrial"

  # --------------------------------------------------------
  # TAGS Y ETIQUETADO (desde tags.yaml)
  # --------------------------------------------------------
  tags:
    assigned:
      type: "array"
      description: "Tags asignados basados en código"
      items:
        type: "object"
        properties:
          tag:
            type: "string"
            description: "Tag principal (ej: LOBITO)"
          normalized:
            type: "string"
            description: "Tag normalizado"
          source:
            type: "object"
            properties:
              match_type:
                type: "string"
                enum: ["code_exact", "code_prefix", "code_pattern", "parts"]
                description: "Tipo de coincidencia"
              selector:
                type: "string"
                description: "Selector que activó el match"
              locale:
                type: "string"
                pattern: "^[a-z]{2}(-[A-Z]{2})?$"
                default: "es-BO"
                description: "Localización del tag"
            required: ["match_type", "selector"]
          expose_in_description:
            type: "boolean"
            default: false
            description: "Incluir en descripción visible"
          expose_in_keywords:
            type: "boolean"
            default: true
            description: "Incluir en palabras clave de búsqueda"
          confidence:
            type: "number"
            minimum: 0
            maximum: 1
            description: "Confianza de la asignación"
        required: ["tag", "normalized", "source"]

  # --------------------------------------------------------
  # TEXTOS GENERADOS
  # --------------------------------------------------------
  text:
    name:
      type: "string"
      max_length: 200
      description: "Nombre generado con plantilla de features.yaml"
      generation_template: "features.description_templates.by_category"

    detail:
      type: "string"
      max_length: 500
      description: "Descripción detallada generada"
      generation_template: "features.description_templates.defaults.detail"

    alt_names:
      type: "array"
      items:
        type: "string"
        max_length: 100
      description: "Nombres alternativos y sinónimos"

    # NUEVO: Contenido SEO optimizado
    seo:
      type: "object"
      properties:
        title: { type: "string", max_length: 60 }
        meta_description: { type: "string", max_length: 160 }
        slug: { type: "string", pattern: "^[a-z0-9\\-]+$" }
        structured_data: { type: "object" }
      description: "Contenido optimizado para SEO"

  # --------------------------------------------------------
  # PROYECCIÓN DE BÚSQUEDA
  # --------------------------------------------------------
  search_projection:
    keywords_visible:
      type: "array"
      items: { type: "string" }
      description: "Keywords visibles en UI"

    keywords_hidden:
      type: "array"
      items: { type: "string" }
      description: "Keywords para búsqueda interna"

    maker_tokens:
      type: "array"
      items:
        type: "string"
        enum_ref: "dims.dimensions.vehicle_makers" # ✅ Validado
      description: "Tokens de marca para filtrado"

    model_tokens:
      type: "array"
      items: { type: "string" }
      description: "Tokens de modelo extraídos de fitment"

    oem_tokens:
      type: "array"
      items: { type: "string" }
      description: "Tokens OEM normalizados para búsqueda"

    # NUEVO: Búsqueda semántica
    semantic_vectors:
      type: "array"
      items: { type: "number" }
      description: "Vectores semánticos para búsqueda avanzada"
      nullable: true

  # --------------------------------------------------------
  # INVENTARIO Y GESTIÓN (expandido)
  # --------------------------------------------------------
  inventory:
    # Identificadores comerciales
    barcode_ean:
      type: "string"
      pattern: "^\\d{13}$"
      nullable: true
      description: "Código de barras EAN-13"

    upc:
      type: "string"
      pattern: "^\\d{12}$"
      nullable: true
      description: "Código UPC"

    supplier_sku:
      type: "string"
