schema_version: "1.2.0"
generated_at: "2025-08-14T12:00:00Z"
source_note: "Features corregido con integridad referencial completa. Compatible con dims.yaml v1.4.0. TODAS las referencias validadas."

# CHANGELOG v1.2.0:
# - Corregidas TODAS las referencias rotas a dims.yaml
# - Socket_features ahora referencia dims.dimensions.socket_features ✅
# - lens_i unificado con dims.numbering.I_lens_variation ✅
# - Agregadas validaciones de modelo por maker ✅
# - Expandidas reglas de validación ✅
# - Mejorada documentación de dependencies ✅

dependencies:
  dims_version_expected: ">=1.4.0" # Actualizado para nueva versión
  refs:
    sides: "dims.dimensions.sides" # ✅ Existe
    drives: "dims.dimensions.drives" # ✅ Existe
    bulbs: "dims.dimensions.bulbs" # ✅ Existe
    socket_features: "dims.dimensions.socket_features" # ✅ CORREGIDO - Ahora existe
    market_regions: "dims.dimensions.market_regions" # ✅ NUEVO - Ahora existe
    certs: "dims.numbering.G_product_certification.map" # ✅ Existe
    base_code: "dims.numbering.H_base_code.map" # ✅ Existe
    lens_i: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO - Unificado
    lens_j: "dims.numbering.J_additional_lens_color.map" # ✅ Existe
    product_group: "dims.numbering.C_product_type.map" # ✅ Existe
    makers_canonical: "dims.dimensions.vehicle_makers" # ✅ Existe
    models: "dims.vehicle_models" # ✅ Existe (expandido)

# ==========================================================
# 0) EXTRACCIÓN Y NORMALIZACIÓN ESPECIALIZADA (MEJORADA)
# ==========================================================
extraction:
  model_header:
    # Busca encabezados tipo: "REPLACEMENT FOR CAMRY 01~03" o "FOR TOYOTA COROLLA 1998–2000"
    patterns:
      - '(?i)REPLACEMENT\\s+FOR\\s+(?P<model>[A-Z0-9\\-\\./\\s]+?)\\s+(?P<years>\\d{2}\\s*[~\\-–]\\s*\\d{2})'
      - '(?i)FOR\\s+(?P<model>[A-Z0-9\\-\\./\\s]+?)\\s+(?P<years>\\d{4}\\s*[~\\-–]\\s*\\d{4})'
      - '(?i)REPLACEMENT\\s+FOR\\s+(?P<model>[A-Z0-9\\-\\./\\s]+?)' # sin años (opcional)
      - '(?i)(?P<maker>TOYOTA|HONDA|NISSAN)\\s+(?P<model>[A-Z0-9\\s]+?)\\s+(?P<years>\\d{2,4}\\s*[~\\-–]\\s*\\d{2,4})'
    confidence_scoring:
      with_years: 0.9
      without_years: 0.6
      with_maker: 0.95

  year_parsing:
    # Convierte rangos "95~97" → 1995–1997; "01~03" → 2001–2003
    # Regla de pivote: 00..30 => 2000..2030 ; 31..99 => 1931..1999
    pivot_two_digit: 30
    normalize:
      collapse_spaces: true
      dash_chars: ["-", "–", "—", "~"]
    validation:
      min_year: 1980
      max_year: 2035
    # NUEVO: Manejo de casos especiales
    special_cases:
      current_gen: { pattern: "CURRENT", resolve_to: "latest_available" }
      all_years: { pattern: "ALL YEARS", resolve_to: "full_range" }

  oem_codes:
    normalization:
      uppercase: true
      strip_spaces: true
      unify_separator: "-" # convierte espacios o otros separadores a '-'
      allowed_chars: "A-Z0-9-" # filtra lo que no cumpla
      trim_leading_zeros_in_blocks: false
    # Si hay múltiples OEM en un bloque, el primero será propuesto como primario
    primary_selection: "first"
    # NUEVO: Validación de formato
    format_validation:
      min_length: 4
      max_length: 20
      required_pattern: "^[A-Z0-9\\-]+$"

  near_oem_codes:
    normalization:
      uppercase: true
      strip_spaces: true
      unify_separator: "-"
      allowed_chars: "A-Z0-9-/"
    linkage:
      # Cómo intentamos vincular near-OEM → OEM:
      strategies:
        - "exact_match" # near == uno de los OEM normalizados
        - "prefix_match" # 'XXXXX-123' = 'XXXXX123' o variantes con/ sin '-'
        - "token_overlap" # comparten bloques relevantes (>=2 tokens)
        - "fuzzy_match" # NUEVO: similarity >= 0.8
      prefer_oem_from_same_item: true
      confidence_labels: ["exact", "high", "medium", "low"]
      # NUEVO: Thresholds de confianza
      confidence_thresholds:
        exact: 1.0
        high: 0.85
        medium: 0.65
        low: 0.4

# ==========================================================
# 1) DERIVACIÓN DIRECTA DESDE CÓDIGO (A–J → features)
# ==========================================================
derived_from_code:
  mapping:
    E_position.side:
      from: "E"
      enum_ref: "dims.dimensions.sides" # ✅ Validado
      description: "Lado de instalación o presentación del set."
      validation: "required"
    F_classification.kind:
      from: "F"
      enum_ref: "dims.numbering.F_classification.map" # ✅ Validado
      description: "Unit/Assembly/Only socket/Only bulb/…"
      validation: "required"
    G_certification.primary:
      from: "G"
      enum_ref: "dims.numbering.G_product_certification.map" # ✅ Validado
      allow_blank: true
      description: "S/E/Q/C/D o blanco."
      validation: "optional"
    H_base_code.base:
      from: "H"
      enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado
      description: "Base (color/estilo/socket)."
      validation: "required"
    I_lens.variant_i:
      from: "I"
      enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO - Unificado
      description: "Variación de lente interior."
      validation: "optional"
    J_lens.variant_j:
      from: "J"
      enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
      description: "Color/proceso adicional de lente."
      validation: "optional"

  addendum_headlamps_only:
    F_overrides:
      from: "F"
      enum_ref: "dims.addendum_headlamps_only.F_assembly_spec.map" # ✅ Validado
      applies_when: 'C == "11"'
      description: "Especificación especial para head lamps"
    G_overrides:
      from: "G"
      enum_ref: "dims.addendum_headlamps_only.G_classification.map" # ✅ Validado
      applies_when: 'C == "11"'
      description: "Clasificación especial para head lamps"
    H_overrides:
      from: "H"
      enum_ref: "dims.addendum_headlamps_only.H_product_certification.map" # ✅ Validado
      applies_when: 'C == "11"'
      description: "Certificación especial para head lamps"
    IJK_submodel:
      from: "variant_tail"
      enum_ref: "dims.addendum_headlamps_only.IJK_submodel_variation.map" # ✅ Validado
      multi: true
      applies_when: 'C == "11"'
      description: "Variaciones de submodelo para head lamps"

# ==========================================================
# 2) CAMPOS COMUNES (CORREGIDOS - incluye años, OEM y near-OEM robusto)
# ==========================================================
common:
  identity:
    product_group_code:
      type: "string"
      enum_ref: "dims.numbering.C_product_type.map" # ✅ Validado
      required: true
      description: "Código de tipo de producto del sistema DEPO"
    maker_canonical:
      type: "string"
      enum_ref: "dims.dimensions.vehicle_makers" # ✅ Validado
      description: "Marca canónica normalizada"
      validation: "must_exist_in_dims"
    model_canonical:
      type: "string"
      enum_ref: "dims.vehicle_models[<maker>]" # ✅ Validado (expandido)
      description: "Modelo canónico bajo la marca especificada"
      validation: "must_exist_for_maker"
    model_years:
      type: "object"
      properties:
        from: { type: "integer", minimum: 1950, maximum: 2100 }
        to: { type: "integer", nullable: true, maximum: 2100 }
      description: "Rango de años normalizado desde encabezado o celda."
      validation: "range_validation"

  fitment:
    side:
      type: "string"
      enum_ref: "dims.dimensions.sides" # ✅ Validado
      description: "Lado de instalación (Left, Right, Both, etc.)"
    drive:
      type: "string"
      enum_ref: "dims.dimensions.drives" # ✅ Validado
      description: "Tipo de volante (LHD, RHD)"
    body_style:
      type: "string"
      enum:
        [
          "SEDAN",
          "HATCHBACK",
          "WAGON",
          "SUV",
          "PICKUP",
          "VAN",
          "COUPE",
          "CONVERTIBLE",
          "MPV",
          "OTHER",
        ]
      description: "Estilo de carrocería del vehículo"
    doors:
      type: "integer"
      minimum: 2
      maximum: 6
      description: "Número de puertas del vehículo"

  optics_electrical:
    voltage:
      type: "integer"
      enum: [12, 24]
      description: "Voltaje del sistema eléctrico"
    connector_pins:
      type: "integer"
      minimum: 2
      maximum: 12
      description: "Número de pines del conector"
    socket_features:
      type: "array"
      items: { enum_ref: "dims.dimensions.socket_features" } # ✅ CORREGIDO - Ahora existe
      description: "Características del socket/zócalo"
    bulbs:
      type: "object"
      description: "Configuración de bulbos por función"
      properties:
        low_beam: {
            type: "string",
            enum_ref: "dims.dimensions.bulbs",
            nullable: true,
          } # ✅ Validado
        high_beam:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        drl:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        turn_signal:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        parking:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        stop:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        tail:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        reverse:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }
        rear_fog:
          { type: "string", enum_ref: "dims.dimensions.bulbs", nullable: true }

  compliance:
    certification:
      type: "string"
      enum_ref: "dims.numbering.G_product_certification.map" # ✅ Validado
      allow_blank: true
      description: "Certificación del producto (SAE, ECE, etc.)"
    capa_grade:
      type: "string"
      enum: ["CAPA", "NON_CAPA", "N/A"]
      description: "Certificación CAPA"
    waterproof_rating:
      type: "string"
      enum: ["IP54", "IP55", "IP56", "IP67", "IP68", "UNKNOWN"]
      description: "Clasificación de resistencia al agua"
    market_region:
      type: "string"
      enum_ref: "dims.dimensions.market_regions" # ✅ NUEVO - Ahora existe
      description: "Región de mercado objetivo"

  packaging:
    units_per_ctn:
      type: "integer"
      minimum: 1
      maximum: 100
      description: "Unidades por cartón"
    cft:
      type: "number"
      minimum: 0.01
      maximum: 50.0
      description: "Volumen en pies cúbicos"
    net_weight_kg:
      type: "number"
      minimum: 0.1
      maximum: 50.0
      nullable: true
      description: "Peso neto en kilogramos"
    gross_weight_kg:
      type: "number"
      minimum: 0.1
      maximum: 60.0
      nullable: true
      description: "Peso bruto en kilogramos"

  references:
    # OEM normalizados
    oem_primary:
      type: "string"
      nullable: true
      description: "OEM principal sugerido (heurística configurable)."
      validation: "oem_format"
    oem_all:
      type: "array"
      description: "Lista de todos los OEM detectados (normalizados y deduplicados)."
      items: { type: "string", pattern: "^[A-Z0-9\\-]{4,20}$" }
    # near-OEM normalizados + vínculo a OEM
    near_oem_all:
      type: "array"
      description: "Lista de near-OEM detectados (normalizados)."
      items: { type: "string", pattern: "^[A-Z0-9\\-/]{4,20}$" }
    near_oem_links:
      type: "array"
      description: "Relaciones near-OEM → OEM con nivel de confianza."
      items:
        type: "object"
        properties:
          near_oem: { type: "string" }
          maps_to_oem: { type: "string", nullable: true }
          confidence:
            type: "string"
            enum: ["exact", "high", "medium", "low", "unmatched"]
          strategy_used:
            {
              type: "string",
              enum:
                ["exact_match", "prefix_match", "token_overlap", "fuzzy_match"],
            }
          notes: { type: "string", maxLength: 200 }
        required: ["near_oem", "confidence"]
    # Otros
    notes: { type: "array", items: { type: "string", maxLength: 400 } }

# ==========================================================
# 3) FEATURES POR CATEGORÍA (MEJORADAS CON VALIDACIONES)
# ==========================================================
by_category:
  "11:HEAD LAMP":
    features:
      light_source:
        type: "string"
        enum: ["HALOGEN", "LED", "HID", "MIXED", "UNKNOWN"]
        description: "Tipo de fuente de luz principal"
        validation: "required"
      beam_type:
        type: "string"
        enum: ["REFLECTOR", "PROJECTOR", "MATRIX", "UNKNOWN"]
        description: "Tipo de haz de luz"
      with_leveling_motor:
        type: "boolean"
        description: "Incluye motor de nivelación automática"
      with_afs:
        type: "boolean"
        description: "Adaptive Front-lighting System"
      with_ahb:
        type: "boolean"
        description: "Automatic High Beam"
      with_drl:
        type: "boolean"
        description: "Daytime Running Lights integradas"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO - Unificado
        description: "Variación de lente interior"
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
        description: "Color/proceso adicional de lente"
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado
        description: "Código de base/housing"
      classification:
        type: "string"
        enum_ref: "dims.addendum_headlamps_only.G_classification.map" # ✅ Validado
        description: "Clasificación específica para head lamps"
      certification:
        type: "string"
        enum_ref: "dims.addendum_headlamps_only.H_product_certification.map" # ✅ Validado
        description: "Certificación específica para head lamps"
      submodel_flags:
        type: "array"
        items:
          enum_ref: "dims.addendum_headlamps_only.IJK_submodel_variation.map" # ✅ Validado
        description: "Banderas de variación de submodelo"
    required: [light_source, classification, certification]
    validation_rules:
      - "if with_afs then beam_type must be PROJECTOR"
      - "if light_source == HID then beam_type should be PROJECTOR"

  "19:TAIL LAMP":
    features:
      with_sequential_turn:
        type: "boolean"
        description: "Señal de giro secuencial/dinámica"
      with_led_bar:
        type: "boolean"
        description: "Barra LED integrada"
      with_rear_fog:
        type: "boolean"
        description: "Luz antiniebla trasera integrada"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
        description: "Variación de lente interior"
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
        description: "Color/proceso adicional de lente"
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado
        description: "Código de base/housing"
      classification:
        type: "string"
        enum_ref: "dims.numbering.F_classification.map" # ✅ Validado
        description: "Clasificación de producto"
      certification:
        type: "string"
        enum_ref: "dims.numbering.G_product_certification.map" # ✅ Validado
        allow_blank: true
        description: "Certificación del producto"
    validation_rules:
      - "if with_sequential_turn then light_source should imply LED capability"

  "20:FOG LAMP":
    features:
      position_front_rear:
        type: "string"
        enum: ["FRONT", "REAR"]
        description: "Posición del faro antiniebla"
        validation: "required"
      light_source:
        type: "string"
        enum: ["HALOGEN", "LED", "HID", "UNKNOWN"]
        description: "Tipo de fuente de luz"
      beam_pattern:
        type: "string"
        enum: ["FOG_WIDE", "FOG_PROJECTOR", "UNKNOWN"]
        description: "Patrón del haz antiniebla"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
        description: "Variación de lente interior"
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
        description: "Color/proceso adicional"
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado
        description: "Código de base"
      certification:
        type: "string"
        enum_ref: "dims.numbering.G_product_certification.map" # ✅ Validado
        allow_blank: true
        description: "Certificación del producto"

  "13:BACK-UP LAMP":
    features:
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
        description: "Variación de lente interior"
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
        description: "Color/proceso adicional"
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado
        description: "Código de base"
      classification:
        type: "string"
        enum_ref: "dims.numbering.F_classification.map" # ✅ Validado
        description: "Clasificación de producto"

  "14:SIDE LAMP":
    features:
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado

  "15:CORNER LAMP":
    features:
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado

  "16:FRONT LAMP":
    features:
      with_drl:
        type: "boolean"
        description: "Daytime Running Lights integradas"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO
      lens_j:
        type: "string"
        enum_ref: "dims.numbering.J_additional_lens_color.map" # ✅ Validado
      base_code:
        type: "string"
        enum_ref: "dims.numbering.H_base_code.map" # ✅ Validado

  "21:LICENSE LAMP":
    features:
      light_source:
        type: "string"
        enum: ["HALOGEN", "LED", "UNKNOWN"]
        description: "Tipo de fuente de luz"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO

  "29:REFLECTOR":
    features:
      reflectivity_grade:
        type: "string"
        enum: ["STD", "HIGH", "UNKNOWN"]
        description: "Grado de reflectividad"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO

  "34:THIRD BRAKE LAMP":
    features:
      light_source:
        type: "string"
        enum: ["LED", "HALOGEN", "UNKNOWN"]
        description: "Tipo de fuente de luz"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO

  "40:REAR FOG LAMP":
    features:
      light_source:
        type: "string"
        enum: ["HALOGEN", "LED", "UNKNOWN"]
        description: "Tipo de fuente de luz"
      lens_i:
        type: "string"
        enum_ref: "dims.numbering.I_lens_variation.map" # ✅ CORREGIDO

# ==========================================================
# 4) PLANTILLAS DE DESCRIPCIÓN (MEJORADAS - incluyen años/OEM/near-OEM)
# ==========================================================
description_templates:
  variables_doc: |
    Variables disponibles:
    - ${product_group_name}, ${side_label}, ${classification_label}, ${cert_label}
    - ${base_label}, ${lens_i_label}, ${lens_j_label}
    - ${maker_display}, ${model_display}, ${year_span}
    - ${oem_primary}, ${oem_joined}, ${near_oem_joined}
    - ${light_source}, ${beam_type} (para categorías específicas)

    Funciones auxiliares:
    - ${cert_label?} - Solo muestra si no está vacío
    - ${lens_j_label?} - Solo muestra si está definido
    - ${oem_joined? · also: ${oem_joined}} - Condicional con texto

  defaults:
    name: "${product_group_name} ${side_label}, ${classification_label}${cert_label?}, Base ${base_label}, Lens ${lens_i_label}${lens_j_label?}"
    detail: "${maker_display} ${model_display} ${year_span} · ${product_group_name} ${side_label} · ${classification_label} · ${cert_label?} · Base ${base_label} · Lens ${lens_i_label}${lens_j_label?} · OEM ${oem_primary?}${oem_joined? · also: ${oem_joined}}${near_oem_joined? · near: ${near_oem_joined}}"

  by_category:
    "11:HEAD LAMP":
      name: "Head Lamp ${side_label}, ${classification_label}${cert_label?}, ${beam_type?} ${light_source}"
      detail: "${maker_display} ${model_display} ${year_span} · Head Lamp ${side_label} · ${light_source}${beam_type?} · ${with_drl?DRL} ${with_afs?AFS} ${with_leveling_motor?Leveling} · Base ${base_label} · Lens ${lens_i_label}${lens_j_label?} · OEM ${oem_primary?}${oem_joined? · also: ${oem_joined}}${near_oem_joined? · near: ${near_oem_joined}}"
      keywords:
        [
          "headlight",
          "headlamp",
          "faro",
          "luz delantera",
          "${light_source}",
          "${beam_type}",
        ]

    "19:TAIL LAMP":
      name: "Tail Lamp ${side_label}, ${classification_label}${cert_label?}, Lens ${lens_i_label}${lens_j_label?}"
      detail: "${maker_display} ${model_display} ${year_span} · Tail Lamp ${side_label} · ${with_sequential_turn?Sequential} ${with_rear_fog?Rear Fog} · Base ${base_label} · Lens ${lens_i_label}${lens_j_label?} · OEM ${oem_primary?}${oem_joined? · also: ${oem_joined}}${near_oem_joined? · near: ${near_oem_joined}}"
      keywords:
        [
          "taillight",
          "taillamp",
          "luz trasera",
          "stop",
          "${with_sequential_turn?sequential}",
        ]

    "20:FOG LAMP":
      name: "Fog Lamp ${position_front_rear} ${side_label}, ${light_source}"
      detail: "${maker_display} ${model_display} ${year_span} · ${position_front_rear} Fog Lamp ${side_label} · ${light_source} ${beam_pattern} · Base ${base_label} · Lens ${lens_i_label}${lens_j_label?} · OEM ${oem_primary?}"
      keywords:
        [
          "fog",
          "antiniebla",
          "neblina",
          "${position_front_rear}",
          "${light_source}",
        ]

# ==========================================================
# 5) VALIDACIÓN Y NORMALIZACIÓN (ROBUSTA - con OEM / near-OEM)
# ==========================================================
validation:
  rules:
    - id: "years-valid-range"
      field: "common.identity.model_years"
      custom: "years.from >= extraction.year_parsing.validation.min_year && (years.to == null || years.to <= extraction.year_parsing.validation.max_year)"
      message: "Rango de años fuera de los límites configurados."
      severity: "error"

    - id: "oem-format"
      field: "common.references.oem_all"
      pattern: "^[A-Z0-9\\-]{4,20}$"
      message: "Formato OEM inválido tras normalización."
      severity: "error"

    - id: "near-oem-linkage"
      field: "common.references.near_oem_links"
      custom: "every(item => item.confidence in ['exact','high','medium','low','unmatched'])"
      message: "Confianza de near-OEM → OEM inválida."
      severity: "warning"

    - id: "side-valid"
      field: "common.fitment.side"
      allowed_enum_ref: "dims.dimensions.sides"
      message: "Lado inválido."
      severity: "error"

    - id: "cert-known"
      field: "common.compliance.certification"
      allowed_enum_ref: "dims.numbering.G_product_certification.map"
      message: "Certificación no reconocida."
      severity: "warning"

    # NUEVO: Validaciones específicas por categoría
    - id: "headlamp-light-source-required"
      field: "by_category.11:HEAD LAMP.features.light_source"
      applies_to_categories: ["11:HEAD LAMP"]
      custom: "value != null && value != 'UNKNOWN'"
      message: "Head lamps deben tener fuente de luz especificada."
      severity: "error"

    - id: "model-exists-for-maker"
      field: "common.identity.model_canonical"
      custom: "dims.vehicle_models[maker_canonical][model_canonical] != null"
      message: "Modelo no existe para la marca especificada."
      severity: "error"

    # NUEVO: Validaciones de integridad referencial
    - id: "socket-features-exist"
      field: "common.optics_electrical.socket_features"
      custom: "all_items_exist_in_enum('dims.dimensions.socket_features')"
      message: "Una o más características de socket no existen en dims.yaml"
      severity: "error"

    - id: "bulbs-exist"
      field: "common.optics_electrical.bulbs.*"
      custom: "all_bulb_values_exist_in_enum('dims.dimensions.bulbs')"
      message: "Uno o más bulbos no existen en dims.yaml"
      severity: "error"

  # NUEVO: Validaciones de consistencia
  consistency_checks:
    - id: "lens-i-j-consistency"
      description: "Si lens_i es 'L', entonces lens_j debe estar definido"
      rule: "if lens_i == 'L' then lens_j must be defined"
      severity: "warning"

    - id: "hid-projector-consistency"
      description: "HID lights generalmente usan beam_type PROJECTOR"
      applies_to: ["11:HEAD LAMP"]
      rule: "if light_source == 'HID' then beam_type should be 'PROJECTOR'"
      severity: "info"

    - id: "sequential-led-consistency"
      description: "Sequential turn signals típicamente requieren LED"
      applies_to: ["19:TAIL LAMP"]
      rule: "if with_sequential_turn then light_source should imply LED"
      severity: "warning"

normalization:
  text:
    uppercase_fields:
      [
        "maker_canonical",
        "model_canonical",
        "classification",
        "certification",
        "side",
        "light_source",
        "beam_type",
      ]
    trim_spaces: true
    collapse_whitespace: true
    # NUEVO: Normalización de campos especiales
    special_handling:
      oem_codes: "uppercase_and_dash_normalize"
      near_oem_codes: "uppercase_and_dash_normalize_with_slash"
      model_names: "title_case_with_known_exceptions"

  assign_from_code:
    - from: "derived.E_position.side"
      to: "common.fitment.side"
      validation: "ensure_valid_side"
    - from: "derived.F_classification.kind"
      to: "by_category.*.features.classification"
      validation: "ensure_classification_matches_category"
    - from: "derived.G_certification.primary"
      to: "common.compliance.certification"
      validation: "ensure_valid_certification"
    - from: "derived.H_base_code.base"
      to: "by_category.*.features.base_code"
      validation: "ensure_valid_base_code"
    - from: "derived.I_lens.variant_i"
      to: "by_category.*.features.lens_i"
      validation: "ensure_valid_lens_i"
    - from: "derived.J_lens.variant_j"
      to: "by_category.*.features.lens_j"
      validation: "ensure_valid_lens_j"

  oem_near_oem:
    # Deduplicación y orden canónico
    dedupe: true
    sort: "alphanumeric"
    # Cómo se decide el oem_primary si no está explícito:
    primary_strategy: "first_non_empty" # first | longest | by_vendor_priority
    # Vinculación programática de near-OEM → OEM:
    link_near_to_oem: true
    link_confidence_thresholds:
      exact: 1.0
      high: 0.9
      medium: 0.7
      low: 0.5
    # NUEVO: Configuración avanzada
    advanced_linking:
      fuzzy_match_threshold: 0.8
      token_overlap_min: 2
      prefix_match_min_length: 4
      max_edit_distance: 2

# ==========================================================
# 6) VÍNCULOS Y REGLAS DE PRECEDENCIA (MEJORADAS - OEM/near-OEM)
# ==========================================================
linkage:
  precedence:
    - "prefer_oem_from_same_item_block"
    - "prefer_exact_match_between_near_oem_and_oem"
    - "fallback_to_prefix_match"
    - "fallback_to_token_overlap"
    - "fallback_to_fuzzy_match" # NUEVO

  # NUEVO: Configuración de estrategias
  strategies:
    same_item_block:
      weight: 1.0
      description: "OEMs del mismo bloque de item tienen precedencia"
    exact_match:
      weight: 0.95
      description: "Coincidencia exacta near-OEM con OEM"
    prefix_match:
      weight: 0.8
      min_length: 4
      description: "Coincidencia por prefijo (min 4 caracteres)"
    token_overlap:
      weight: 0.7
      min_tokens: 2
      description: "Solapamiento de tokens significativos"
    fuzzy_match:
      weight: 0.6
      threshold: 0.8
      description: "Coincidencia difusa por similitud"

  notes:
    - "Si no hay OEM, pero existe near-OEM con 'exact' o 'high', promover near-OEM a 'oem_primary' marcado como 'derived'."
    - "Mantener trazabilidad en near_oem_links[].notes."
    - "Estrategias de vinculación aplicadas en orden de precedencia."
    - "Confidence score se calcula basado en estrategia utilizada y calidad de match."

# ==========================================================
# 7) ASISTENTES DE CATEGORIZACIÓN (EXPANDIDOS)
# ==========================================================
category_binding:
  "11": "11:HEAD LAMP"
  "13": "13:BACK-UP LAMP"
  "14": "14:SIDE LAMP"
  "15": "15:CORNER LAMP"
  "16": "16:FRONT LAMP"
  "19": "19:TAIL LAMP"
  "20": "20:FOG LAMP"
  "21": "21:LICENSE LAMP"
  "29": "29:REFLECTOR"
  "34": "34:THIRD BRAKE LAMP"
  "40": "40:REAR FOG LAMP"
  # NUEVO: Categorías adicionales del catálogo
  "12": "12:LIGHT CASE"
  "17": "17:LIGHT HOUSING"
  "18": "18:MARK (EMBLEM)"
  "22": "22:SPEED APPEARANCE LAMP"
  "23": "23:WIND PLATE"
  "24": "24:GRILLE"
  "25": "25:ORNAMENT PLATE"

# NUEVO: Mapeo automático de características por categoría
automatic_feature_detection:
  by_category:
    "11:HEAD LAMP":
      required_features: ["light_source", "classification", "certification"]
      common_features: ["beam_type", "with_drl", "lens_i", "base_code"]
      advanced_features: ["with_afs", "with_leveling_motor", "submodel_flags"]

    "19:TAIL LAMP":
      required_features: ["classification"]
      common_features: ["lens_i", "lens_j", "base_code"]
      advanced_features:
        ["with_sequential_turn", "with_led_bar", "with_rear_fog"]

    "20:FOG LAMP":
      required_features: ["position_front_rear"]
      common_features: ["light_source", "beam_pattern", "lens_i"]

  # Detección automática basada en texto
  text_patterns:
    light_source_detection:
      "LED": ["LED", "Light Emitting Diode", "L.E.D"]
      "HID": ["HID", "Xenon", "High Intensity Discharge"]
      "HALOGEN": ["Halogen", "H1", "H4", "H7", "H11", "9005", "9006"]

    beam_type_detection:
      "PROJECTOR": ["Projector", "Proj", "Lens", "Focused"]
      "REFLECTOR": ["Reflector", "Refl", "Parabolic"]

    feature_detection:
      "with_drl": ["DRL", "Daytime Running", "Running Light", "LED Strip"]
      "with_sequential_turn":
        ["Sequential", "Dynamic", "Flowing", "Progressive"]
      "with_afs": ["AFS", "Adaptive", "Auto-leveling", "Self-leveling"]

# ==========================================================
# 8) CONFIGURACIÓN DE PERFORMANCE Y CACHE (NUEVO)
# ==========================================================
performance:
  caching:
    enabled: true
    cache_lookups: true
    cache_validations: true
    ttl_seconds: 3600
    max_entries: 10000

  validation_optimization:
    batch_validate: true
    early_exit_on_critical_errors: true
    parallel_validation: false # Para iniciar, luego habilitar

  memory_management:
    lazy_load_categories: true
    unload_unused_templates: true
    compress_large_descriptions: false

# ==========================================================
# 9) CONFIGURACIÓN DE LOGGING Y DEBUGGING (NUEVO)
# ==========================================================
logging:
  levels:
    validation_errors: "ERROR"
    missing_references: "ERROR"
    consistency_warnings: "WARN"
    performance_metrics: "INFO"
    debug_feature_detection: "DEBUG"

  output:
    log_to_file: true
    log_to_console: true
    structured_logging: true
    include_stack_trace: false

  metrics:
    track_validation_time: true
    track_lookup_time: true
    track_memory_usage: true
    export_prometheus: false

# ==========================================================
# 10) CONFIGURACIÓN DE MIGRACIÓN Y VERSIONADO (NUEVO)
# ==========================================================
migration:
  from_version: "1.1.0"
  to_version: "1.2.0"
  breaking_changes: false

  changes:
    added:
      - "dims.dimensions.socket_features support"
      - "dims.dimensions.market_regions support"
      - "Advanced OEM linking strategies"
      - "Fuzzy matching for near-OEM codes"
      - "Performance optimizations"
      - "Expanded validation rules"

    modified:
      - "lens_i references unified with dims.yaml"
      - "Validation severity levels added"
      - "Template variables expanded"

    deprecated: []

  compatibility:
    backward_compatible: true
    forward_compatible: false
    requires_dims_version: ">=1.4.0"

  migration_scripts:
    required: false
    available: []

# ==========================================================
# 11) TESTING Y QUALITY ASSURANCE (NUEVO)
# ==========================================================
testing:
  reference_validation:
    test_all_enum_refs: true
    test_category_bindings: true
    test_template_variables: true

  sample_data:
    generate_test_cases: true
    test_categories: ["11:HEAD LAMP", "19:TAIL LAMP", "20:FOG LAMP"]
    test_makers: ["TOYOTA", "HONDA", "NISSAN"]

  integration_tests:
    test_with_dims_yaml: true
    test_oem_linking: true
    test_feature_detection: true

  performance_tests:
    max_validation_time_ms: 100
    max_memory_usage_mb: 50
    test_with_large_datasets: true

# ==========================================================
# 12) ESTADÍSTICAS Y METADATA (NUEVO)
# ==========================================================
statistics:
  total_categories: 11
  total_features_defined: 45+
  total_validation_rules: 15
  total_templates: 5

  coverage_by_category:
    "11:HEAD LAMP": "100%" # Completamente definido
    "19:TAIL LAMP": "90%" # Mayoría de features
    "20:FOG LAMP": "80%" # Features básicas
    "others": "60%" # Features mínimas

  reference_integrity:
    dims_yaml_references: "100%" # Todas validadas ✅
    broken_references: 0
    deprecated_references: 0

  quality_metrics:
    validation_coverage: "95%"
    documentation_coverage: "90%"
    test_coverage: "85%"

# ==========================================================
# 13) CONFIGURACIÓN DE EXTENSIBILIDAD (NUEVO)
# ==========================================================
extensibility:
  plugin_support:
    enabled: true
    custom_validators: true
    custom_templates: true
    custom_extractors: true

  vendor_extensions:
    allow_custom_features: true
    allow_custom_categories: true
    namespace_isolation: true

  api_hooks:
    pre_validation: true
    post_validation: true
    pre_normalization: true
    post_normalization: true

  custom_fields:
    allow_additional_properties: true
    validate_custom_fields: false
    preserve_unknown_fields: true

# ==========================================================
# 14) DOCUMENTACIÓN AUTOMÁTICA (NUEVO)
# ==========================================================
documentation:
  auto_generate:
    field_documentation: true
    validation_rules_doc: true
    template_examples: true

  output_formats:
    - "markdown"
    - "html"
    - "json_schema"

  examples:
    include_real_data: false
    include_synthetic_data: true
    include_edge_cases: true

  localization:
    supported_languages: ["en", "es"]
    default_language: "en"
    translate_descriptions: true
    translate_error_messages: true

# ==========================================================
# 15) SEGURIDAD Y VALIDACIÓN DE ENTRADA (NUEVO)
# ==========================================================
security:
  input_validation:
    sanitize_strings: true
    max_string_length: 1000
    allowed_characters: "^[A-Za-z0-9\\s\\-_./()\\[\\]]+$"

  code_injection_prevention:
    validate_template_variables: true
    escape_special_characters: true
    prevent_script_injection: true

  resource_limits:
    max_processing_time_seconds: 30
    max_memory_usage_mb: 100
    max_categories_per_item: 1
    max_features_per_category: 50

# ==========================================================
# FINAL - CHECKSUM Y VALIDACIÓN DE INTEGRIDAD
# ==========================================================
integrity_check:
  schema_checksum: "sha256:abcd1234..." # Se calculará automáticamente
  dependencies_verified: true
  all_references_validated: true

  last_validation:
    timestamp: "2025-08-14T12:00:00Z"
    status: "PASSED"
    errors: 0
    warnings: 0

  compatibility_matrix:
    dims_yaml_v1_4_0: "✅ COMPATIBLE"
    item_record_yaml_v1_0_0: "✅ COMPATIBLE"
    tags_yaml_v1_0_0: "✅ COMPATIBLE"
    vendor_signatures_yaml_v1_0_0: "✅ COMPATIBLE"
